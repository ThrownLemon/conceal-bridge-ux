#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Pre-commit hook for Conceal Bridge
# Runs quality gates and blocks forbidden patterns

echo "üîç Running pre-commit checks..."

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check for forbidden patterns
# We break up the strings to avoid this script flagging itself
FORBIDDEN_PATTERNS="eslint""-disable @ts""-ignore @ts""-expect-error @ts""-nocheck"

# Get all staged files
ALL_STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$ALL_STAGED_FILES" ]; then
  echo "No staged files to check."
  exit 0
fi

# Filter for files to check for forbidden patterns (exclude md and hook script)
CHECK_FILES=$(echo "$ALL_STAGED_FILES" | grep -vE "\.md$|pre-commit$" || true)

# Check for forbidden patterns in staged files
FOUND_FORBIDDEN=0
if [ -n "$CHECK_FILES" ]; then
  for pattern in $FORBIDDEN_PATTERNS; do
    # Use grep to find the pattern in staged files
    # We use git show to get the content of the staged file
    for file in $CHECK_FILES; do
      if git show ":$file" | grep -q "$pattern"; then
        echo "${RED}‚ùå Found forbidden pattern '$pattern' in $file${NC}"
        FOUND_FORBIDDEN=1
      fi
    done
  done
fi

if [ $FOUND_FORBIDDEN -eq 1 ]; then
  echo ""
  echo "${RED}‚ùå Pre-commit check failed!${NC}"
  echo "Forbidden patterns detected. Please:"
  echo "  1. Remove eslint""-disable comments and fix the underlying issue"
  echo "  2. Remove @ts""-ignore/@ts""-expect-error and fix the type error"
  echo "  3. Only use these patterns if absolutely necessary and document why"
  echo ""
  echo "If you must use a forbidden pattern, add a comment explaining why."
  exit 1
fi

# Run quality gates
echo ""
echo "üìã Running quality gates..."

# Format first (must run before build)
echo "‚Üí Running npm run format..."
npm run format
FORMAT_EXIT=$?

if [ $FORMAT_EXIT -ne 0 ]; then
  echo "${RED}‚ùå Format check failed!${NC}"
  echo "Please run 'npm run format' and commit the formatting changes."
  exit 1
fi

# Check if formatting changed any files
if ! git diff --quiet; then
  echo "${YELLOW}‚ö†Ô∏è  Formatting changed files. Please add them to your commit:${NC}"
  git diff --name-only | sed 's/^/  - /'
  echo ""
  echo "Run: git add . && git commit --amend --no-edit"
  exit 1
fi

# Lint
echo "‚Üí Running npm run lint..."
npm run lint
LINT_EXIT=$?

if [ $LINT_EXIT -ne 0 ]; then
  echo "${RED}‚ùå Lint check failed!${NC}"
  echo "Please run 'npm run lint' and fix the errors."
  exit 1
fi

# Tests
echo "‚Üí Running npm test..."
npm test
TEST_EXIT=$?

if [ $TEST_EXIT -ne 0 ]; then
  echo "${RED}‚ùå Tests failed!${NC}"
  echo "Please run 'npm test' and fix the failing tests."
  exit 1
fi

# Build
echo "‚Üí Running npm run build..."
npm run build
BUILD_EXIT=$?

if [ $BUILD_EXIT -ne 0 ]; then
  echo "${RED}‚ùå Build failed!${NC}"
  echo "Please run 'npm run build' and fix the build errors."
  exit 1
fi

echo ""
echo "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
exit 0