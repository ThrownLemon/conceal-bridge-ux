# Pre-commit hook for Conceal Bridge
# Runs quality gates and blocks forbidden patterns

echo "üîç Running pre-commit checks..."

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check for forbidden patterns
# We break up the strings to avoid this script flagging itself
FORBIDDEN_PATTERNS="eslint""-disable @ts""-ignore @ts""-expect-error @ts""-nocheck"

# Get all staged files
ALL_STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$ALL_STAGED_FILES" ]; then
  echo "No staged files to check."
  exit 0
fi

# Filter for files to check for forbidden patterns (exclude md and hook script)
CHECK_FILES=$(echo "$ALL_STAGED_FILES" | grep -vE "\.md$|pre-commit$" || true)

# Check for forbidden patterns in staged files
FOUND_FORBIDDEN=0
if [ -n "$CHECK_FILES" ]; then
  for pattern in $FORBIDDEN_PATTERNS; do
    # Use grep to find the pattern in staged files
    # We use git show to get the content of the staged file
    for file in $CHECK_FILES; do
      if git show ":$file" | grep -q "$pattern"; then
        echo "${RED}‚ùå Found forbidden pattern '$pattern' in $file${NC}"
        FOUND_FORBIDDEN=1
      fi
    done
  done
fi

if [ $FOUND_FORBIDDEN -eq 1 ]; then
  echo ""
  echo "${RED}‚ùå Pre-commit check failed!${NC}"
  echo "Forbidden patterns detected. Please:"
  echo "  1. Remove eslint""-disable comments and fix the underlying issue"
  echo "  2. Remove @ts""-ignore/@ts""-expect-error and fix the type error"
  echo "  3. Only use these patterns if absolutely necessary and document why"
  echo ""
  echo "If you must use a forbidden pattern, add a comment explaining why."
  exit 1
fi

# Run quality gates
echo ""
echo "üìã Running quality gates..."

# Format first (must run before build)
# IMPORTANT:
# - Only format files that are part of the commit (staged files)
# - Never touch unrelated/untracked files in the working directory
# - Avoid breaking partial commits: skip files that are staged *and* have unstaged changes
echo "‚Üí Formatting staged files with Prettier..."

FORMATTED_FILES=""
SKIPPED_PARTIAL_FILES=""

while IFS= read -r file; do
  [ -z "$file" ] && continue

  # Safety: only operate on files that exist in the working tree
  # (staged files can include renames; deleted files are excluded via diff-filter)
  if [ ! -f "$file" ]; then
    continue
  fi

  # If the file has unstaged changes, formatting would rewrite it and can break partial commits.
  # We skip in that case and let the user decide whether to fully stage the file.
  if ! git diff --quiet -- "$file"; then
    SKIPPED_PARTIAL_FILES="${SKIPPED_PARTIAL_FILES}
$file"
    continue
  fi

  # Format the staged file only. --ignore-unknown allows non-prettier files to be skipped safely.
  npx --no-install prettier --write --ignore-unknown -- "$file"
  FORMAT_EXIT=$?
  if [ $FORMAT_EXIT -ne 0 ]; then
    echo "${RED}‚ùå Formatting failed for: $file${NC}"
    exit 1
  fi

  # Re-stage in case Prettier updated the file.
  git add -- "$file"

  # Ensure Prettier didn't leave unstaged changes for this file.
  if ! git diff --quiet -- "$file"; then
    echo "${RED}‚ùå Formatting produced unstaged changes for: $file${NC}"
    echo "This usually indicates the file has mixed staged/unstaged hunks or another process modified it."
    echo "Please review the file, stage the intended changes, and try again."
    exit 1
  fi

  FORMATTED_FILES="${FORMATTED_FILES}
$file"
done <<EOF
$ALL_STAGED_FILES
EOF

if [ -n "$SKIPPED_PARTIAL_FILES" ]; then
  echo "${YELLOW}‚ö†Ô∏è  Skipped formatting for partially-staged files (to preserve partial commits):${NC}"
  printf "%s\n" "$SKIPPED_PARTIAL_FILES" | sed '/^$/d' | sed 's/^/  - /'
  echo "${YELLOW}    Tip: stage the whole file if you want it auto-formatted.${NC}"
fi

# Lint
echo "‚Üí Running npm run lint..."
npm run lint
LINT_EXIT=$?

if [ $LINT_EXIT -ne 0 ]; then
  echo "${RED}‚ùå Lint check failed!${NC}"
  echo "Please run 'npm run lint' and fix the errors."
  exit 1
fi

# Tests
echo "‚Üí Running npm test..."
npm test
TEST_EXIT=$?

if [ $TEST_EXIT -ne 0 ]; then
  echo "${RED}‚ùå Tests failed!${NC}"
  echo "Please run 'npm test' and fix the failing tests."
  exit 1
fi

# Build
echo "‚Üí Running npm run build..."
npm run build
BUILD_EXIT=$?

if [ $BUILD_EXIT -ne 0 ]; then
  echo "${RED}‚ùå Build failed!${NC}"
  echo "Please run 'npm run build' and fix the build errors."
  exit 1
fi

echo ""
echo "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
exit 0