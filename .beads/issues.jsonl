{"id":"conceal-bridge-ux-0yo","title":"Implement Observability \u0026 Client Logging","description":"## Context / Current State\n\n- The app registers browser-level global error listeners via [`provideBrowserGlobalErrorListeners()`](conceal-bridge-ux/src/app/app.config.ts:9).\n- HTTP calls are performed via Angular `HttpClient` without interceptors (see [`provideHttpClient()`](conceal-bridge-ux/src/app/app.config.ts:10) and notes in [`http_and_error_handling.md`](conceal-bridge-ux/ai_spec/http_and_error_handling.md:6)).\n- Swap flows set user-facing errors locally (signals like [`pageError`](conceal-bridge-ux/src/app/pages/swap/swap.page.ts:445) and [`statusMessage`](conceal-bridge-ux/src/app/pages/swap/swap.page.ts:446)).\n- The existing HTTP spec explicitly defers “full observability stack (Sentry/etc.)” as a follow-up (see [`http_and_error_handling.md`](conceal-bridge-ux/ai_spec/http_and_error_handling.md:23)).\n\n## Goal\n\nIntroduce a consistent, low-friction observability layer so we can:\n\n- capture unexpected runtime errors with context (route, network, wallet connector, etc.)\n- log expected failures in a structured way (timeouts, network errors, wallet rejections)\n- correlate client events with backend logs (request/correlation ID)\n- do all of this **without exposing secrets or sensitive user data**\n\n## Non-Goals\n\n- Implementing a full product analytics solution.\n- Capturing or storing seed phrases, private keys, or other secrets (never allowed).\n- Building a backend telemetry ingestion pipeline in this spec.\n- Retrofitting every legacy call site immediately (migrate incrementally).\n\n## Requirements\n\n1. **Structured logging interface**\n   - A single logging API with levels: `debug | info | warn | error`.\n   - Logs must support structured metadata (`Record\u003cstring, unknown\u003e`).\n\n2. **Redaction \u0026 privacy**\n   - No secrets or high-risk PII in logs.\n   - Default redaction of:\n     - WalletConnect project id (see [`walletConnectProjectId`](conceal-bridge-ux/src/app/core/app-config.ts:14))\n     - full wallet addresses (allow only short form unless user explicitly opts-in)\n     - emails (email fields exist in swap init calls; see `email?: string` in [`sendWccxToCcxInit()`](conceal-bridge-ux/src/app/core/bridge-api.service.ts:67))\n\n3. **Error capture**\n   - Capture unhandled errors and convert them into a safe, structured event.\n\n4. **Correlation**\n   - Add a client-generated correlation ID per app load and per request.\n   - If an HTTP interceptor is added per [`http_and_error_handling.md`](conceal-bridge-ux/ai_spec/http_and_error_handling.md:42), it must add this correlation ID to outgoing requests (header).\n\n5. **Environment toggles**\n   - Ability to turn reporting on/off by environment/config.\n   - In local dev, default to console output.\n   - In production, allow routing to an error-reporting backend (future) or third-party tool (optional).\n\n## Proposed Solution\n\n### A) Add a `LoggerService` abstraction\n\nCreate a core service:\n\n- [`conceal-bridge-ux/src/app/core/logger.service.ts`](conceal-bridge-ux/src/app/core/logger.service.ts:1)\n\nResponsibilities:\n\n- Provide methods `debug()`, `info()`, `warn()`, `error()`.\n- Attach base context:\n  - app version (from build-time environment if available)\n  - route (Angular Router current URL)\n  - network key (if known)\n  - wallet connector id (see [`WalletConnectorId`](conceal-bridge-ux/src/app/core/evm-wallet.service.ts:23))\n- Redact known sensitive values.\n\n### B) Add an `ErrorReporter` adapter (optional)\n\nA small interface that can be implemented by:\n\n- console reporter (default)\n- Sentry (optional future)\n- custom backend endpoint (optional future)\n\nProposed location:\n\n- [`conceal-bridge-ux/src/app/core/error-reporter.ts`](conceal-bridge-ux/src/app/core/error-reporter.ts:1)\n\n### C) Wire global error capture into the logger\n\nLeverage the fact we already register browser listeners via [`provideBrowserGlobalErrorListeners()`](conceal-bridge-ux/src/app/app.config.ts:9):\n\n- Add a global handler that forwards uncaught errors to `LoggerService.error()` and `ErrorReporter`.\n\nNotes:\n\n- User-facing UX should still use the per-page patterns (e.g. [`statusMessage`](conceal-bridge-ux/src/app/pages/swap/swap.page.ts:446)). Logging is not a replacement for UX.\n\n### D) Correlation ID strategy\n\n- Generate an `appSessionId` on first load and store in memory only (not localStorage).\n- Generate a `requestId` per HTTP request.\n\nIf/when HTTP interceptors are implemented (per [`http_and_error_handling.md`](conceal-bridge-ux/ai_spec/http_and_error_handling.md:42)):\n\n- Add header: `X-Request-Id: \u003cuuid\u003e` and `X-Session-Id: \u003cuuid\u003e` (names can be adjusted to backend conventions).\n\n### E) Event taxonomy (recommendation)\n\nStandardize event names so logs are searchable:\n\n- `wallet.connect.start|success|error`\n- `wallet.disconnect.start|success|error`\n- `wallet.ensureChain.start|success|error` (see [`ensureChain()`](conceal-bridge-ux/src/app/core/evm-wallet.service.ts:205))\n- `swap.ccxToEvm.start|error|completed`\n- `swap.evmToCcx.start|error|completed`\n- `api.request.error` (include endpoint, status, mapped category per error mapping spec)\n\n## Acceptance Criteria\n\n1. A central logging API exists and is used for new work.\n2. Unhandled errors are captured and logged with safe context.\n3. HTTP calls include correlation IDs once interceptor work is implemented.\n4. No logs contain secrets or raw wallet keys/seed phrases (audit checklist documented).\n\n## Testing Plan\n\n- Unit tests:\n  - redaction logic (wallet address shortening, email removal)\n  - correlation ID generation format\n- Manual tests:\n  - simulate runtime error and confirm it logs in dev console without crashing the app\n  - verify no wallet prompts triggered by logging layer\n- Security review:\n  - grep output logs in dev to confirm no accidental full addresses/emails\n\n## Risks / Considerations\n\n- Over-logging can leak sensitive context; default to minimal + redacted.\n- Third-party reporting tools may conflict with CSP; coordinate with [`security_headers_and_csp.md`](conceal-bridge-ux/ai_spec/security_headers_and_csp.md:41) when enabled.\n- Logging must not introduce new runtime errors or block UI (log operations must be fire-and-forget).\n\n## Implementation Steps (Work Breakdown)\n\n1. Add `LoggerService` with redaction and base context.\n2. Add `ErrorReporter` interface + console implementation.\n3. Hook global error capture into logger/reporter.\n4. (Optional) Add Sentry or backend reporter, guarded by environment flags.\n5. Integrate correlation IDs into HTTP interceptor work described in [`http_and_error_handling.md`](conceal-bridge-ux/ai_spec/http_and_error_handling.md:42).","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-20T12:50:00.289120867Z","updated_at":"2025-12-20T12:54:13.221110318Z"}
{"id":"conceal-bridge-ux-6i6","title":"Configure Security Headers \u0026 CSP","description":"## Context / Current State\n\n- This is a static Angular SPA (standalone bootstrapped via [`bootstrapApplication()`](conceal-bridge-ux/src/main.ts:1)).\n- The app calls a backend API via a configurable base URL in [`APP_CONFIG.apiBaseUrl`](conceal-bridge-ux/src/app/core/app-config.ts:8), consumed by [`BridgeApiService`](conceal-bridge-ux/src/app/core/bridge-api.service.ts:20).\n- The app integrates with EVM wallets (injected providers + WalletConnect) via [`EvmWalletService`](conceal-bridge-ux/src/app/core/evm-wallet.service.ts:33).\n- The UI loads local static assets from [`public/`](conceal-bridge-ux/public:1) (images for networks/wallets referenced by [`WalletButtonComponent`](conceal-bridge-ux/src/app/shared/wallet/wallet-button.component.ts:256)).\n- The home page indicates it loads chain metadata from a public API (see note in [`HomePage`](conceal-bridge-ux/src/app/pages/home/home.page.ts:141)), so there may be external `connect-src` and/or external `img-src` requirements.\n\n## Goal\n\nDefine a **safe default set of security headers** (especially CSP) for deployment of `conceal-bridge-ux` that:\n\n- reduces XSS and injection risk\n- allows necessary connections for:\n  - the bridge backend\n  - WalletConnect (if enabled)\n  - any chain metadata API the app uses\n- remains compatible with Angular production builds (hashed asset filenames via `outputHashing` in [`angular.json`](conceal-bridge-ux/angular.json:48))\n\n## Non-Goals\n\n- Perfect CSP on day 1 (CSP is iterative).\n- Blocking all external connections (WalletConnect requires external connectivity).\n- Managing security headers in-app (this should be done at the hosting/CDN layer).\n\n## Requirements\n\n1. Provide recommended headers for static hosting (Nginx, S3/CloudFront, Netlify, etc.).\n2. Provide a baseline CSP with clear extension points for:\n   - backend API host(s) from [`APP_CONFIG`](conceal-bridge-ux/src/app/core/app-config.ts:3)\n   - chain metadata host(s) (as used by [`EvmChainMetadataService`](conceal-bridge-ux/src/app/core/evm-chain-metadata.service.ts:1))\n   - WalletConnect endpoints when [`walletConnectProjectId`](conceal-bridge-ux/src/app/core/app-config.ts:14) is enabled\n3. Document how to validate CSP correctness (report-only rollout).\n\n## Recommended Security Headers\n\n\u003e Apply these at the hosting layer for all responses, unless otherwise noted.\n\n### 1) Content-Security-Policy (CSP)\n\nStart with **Report-Only** first, then enforce once verified.\n\n**Baseline (Report-Only example):**\n\n```\nContent-Security-Policy-Report-Only:\n  default-src 'self';\n  base-uri 'self';\n  object-src 'none';\n  frame-ancestors 'none';\n  form-action 'self';\n  img-src 'self' data: https:;\n  font-src 'self' data: https:;\n  style-src 'self' 'unsafe-inline';\n  script-src 'self';\n  connect-src 'self' https:;\n  upgrade-insecure-requests;\n  report-to csp-endpoint;\n```\n\nNotes:\n\n- `style-src 'unsafe-inline'` is often needed if any inline styles are emitted by tooling or a CSS-in-JS dependency. Tighten later if feasible.\n- `connect-src https:` is permissive to reduce breakage during rollout; tighten to explicit hosts once the allowlist is known (see “Allowlist Derivation” below).\n\n**Enforced CSP (target state):**\n\nOnce you identify exact hosts, tighten:\n\n- `img-src`: allow only required external image hosts (ideally none; prefer local assets in [`public/`](conceal-bridge-ux/public:1))\n- `connect-src`: allow only:\n  - bridge backend base domain(s) used by [`BridgeApiService`](conceal-bridge-ux/src/app/core/bridge-api.service.ts:20)\n  - chain metadata API domain(s) used by [`EvmChainMetadataService`](conceal-bridge-ux/src/app/core/evm-chain-metadata.service.ts:1)\n  - WalletConnect endpoints (if WalletConnect is enabled)\n\nExample tightened form (placeholders for actual domains):\n\n```\nContent-Security-Policy:\n  default-src 'self';\n  base-uri 'self';\n  object-src 'none';\n  frame-ancestors 'none';\n  form-action 'self';\n  img-src 'self' data:;\n  font-src 'self' data:;\n  style-src 'self' 'unsafe-inline';\n  script-src 'self';\n  connect-src 'self'\n    https://bridge.conceal.network\n    https://\u003cCHAIN_METADATA_API_HOST\u003e\n    https://\u003cWALLETCONNECT_HOSTS\u003e;\n  upgrade-insecure-requests;\n```\n\n#### WalletConnect CSP considerations\n\nIf using WalletConnect provider initialization in [`EvmWalletService`](conceal-bridge-ux/src/app/core/evm-wallet.service.ts:298), the app may need `connect-src` permissions to WalletConnect infrastructure.\n\nBecause WalletConnect endpoints can evolve, prefer:\n\n- allowlist the minimum set from WalletConnect docs\n- verify via CSP report logs and browser network logs\n\n### 2) Strict-Transport-Security (HSTS)\n\nOnly if you serve HTTPS (production should):\n\n```\nStrict-Transport-Security: max-age=31536000; includeSubDomains; preload\n```\n\n(Do not enable `preload` until you’re sure every subdomain supports HTTPS.)\n\n### 3) X-Content-Type-Options\n\n```\nX-Content-Type-Options: nosniff\n```\n\n### 4) Referrer-Policy\n\n```\nReferrer-Policy: strict-origin-when-cross-origin\n```\n\n### 5) Permissions-Policy\n\nStart restrictive:\n\n```\nPermissions-Policy: geolocation=(), microphone=(), camera=(), payment=(), usb=()\n```\n\nAdjust only if needed.\n\n### 6) Cross-Origin policies (optional, be careful)\n\n- If you are not using SharedArrayBuffer or cross-origin isolation, avoid breaking changes:\n  - `Cross-Origin-Embedder-Policy` and `Cross-Origin-Opener-Policy` can break third-party integrations.\n- Recommended safe baseline:\n\n```\nCross-Origin-Opener-Policy: same-origin\nCross-Origin-Resource-Policy: same-origin\n```\n\nValidate with WalletConnect flows before enforcing broadly.\n\n## Allowlist Derivation (How to get the right CSP)\n\n1. Deploy with `Content-Security-Policy-Report-Only` first.\n2. Use your browser devtools network panel while exercising:\n   - home page load + chain metadata load (see note in [`HomePage`](conceal-bridge-ux/src/app/pages/home/home.page.ts:141))\n   - swap flows calling backend via [`BridgeApiService`](conceal-bridge-ux/src/app/core/bridge-api.service.ts:13)\n   - WalletConnect connect flow via [`WalletButtonComponent`](conceal-bridge-ux/src/app/shared/wallet/wallet-button.component.ts:286)\n3. Capture all blocked/attempted `connect-src`, `img-src`, and `frame-src`.\n4. Tighten `connect-src` and `img-src` to explicit hosts only.\n\n## Runtime Config Interaction\n\nIf you adopt runtime config per [`runtime_config.md`](conceal-bridge-ux/ai_spec/runtime_config.md:1), ensure CSP allows:\n\n- fetching `/config.json` from self:\n  - keep `connect-src 'self'`\n- any configured backend host(s) still fit within the allowlist\n\n## Acceptance Criteria\n\n1. App works under `CSP-Report-Only` with no critical violations during normal flows.\n2. Tightened CSP can be enforced without breaking:\n   - backend calls\n   - wallet flows\n   - chain metadata loads\n3. All recommended non-CSP headers are applied in production hosting.\n\n## Testing Plan\n\n- Manual:\n  - Verify no console CSP errors under Report-Only.\n  - Confirm swap flow works end-to-end with test backend.\n  - Confirm WalletConnect works when enabled.\n- Automated:\n  - E2E suite (see [`e2e_testing.md`](conceal-bridge-ux/ai_spec/e2e_testing.md:1)) should run with headers enabled in a staging environment if feasible.\n\n## Implementation Steps (Work Breakdown)\n\n1. Add `CSP-Report-Only` + reporting endpoint in hosting/CDN.\n2. Exercise main flows; collect reported violations.\n3. Create allowlist; switch to enforced `Content-Security-Policy`.\n4. Add remaining security headers.\n5. Document final header values in the deployment spec [`deployment_static_hosting.md`](conceal-bridge-ux/ai_spec/deployment_static_hosting.md:1).","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-20T12:50:00.411402558Z","updated_at":"2025-12-20T12:54:13.068540827Z"}
{"id":"conceal-bridge-ux-7hp","title":"Implement EVM ↔ EVM Swaps","description":"## Context / Current State\n\n- The Home flow explicitly blocks direct EVM-to-EVM swaps:\n  - “Direct EVM-to-EVM swaps are not supported yet…” in [`HomePage.go()`](conceal-bridge-ux/src/app/pages/home/home.page.ts:425).\n- The network selector enforces “exactly one side is CCX”:\n  - see the constraint in [`HomePage.normalizeNetworks()`](conceal-bridge-ux/src/app/pages/home/home.page.ts:359).\n- Current supported EVM networks are:\n  - Ethereum (1), BSC (56), Polygon (137) via [`EVM_NETWORKS`](conceal-bridge-ux/src/app/core/evm-networks.ts:11).\n- Current swap routes are CCX-centric only:\n  - `/swap/:direction/:network` with directions `'ccx-to-evm' | 'evm-to-ccx'` in [`routes`](conceal-bridge-ux/src/app/app.routes.ts:3).\n\n## Goal\n\nAdd support for **EVM ↔ EVM** swap flows in the UI **without breaking** the existing CCX ↔ EVM bridge flows.\n\nUsers should be able to select an EVM network on both sides (e.g. Ethereum → Polygon), connect a wallet, and complete a swap with clear statuses, safe validation, and predictable error handling.\n\n## Non-Goals\n\n- Implementing a full DEX aggregator in the frontend.\n- Performing “real cross-chain bridging” on-chain without backend support.\n- Supporting non-EVM chains.\n- Adding a full “bridge explorer” / account history (separate spec).\n\n## Assumptions / Dependencies\n\nAt least one of the following must be true (to be decided with backend team):\n\n1. **Backend-driven EVM↔EVM bridging**\n   - Backend exposes idempotent endpoints for quote + execution + status, similar to current bridge endpoints in [`BridgeApiService`](conceal-bridge-ux/src/app/core/bridge-api.service.ts:13).\n\nOR\n\n2. **Frontend-driven EVM↔EVM routing**\n   - The UI integrates an external bridging/DEX SDK, and the backend is only used for analytics/optional support.\n   - This requires careful CSP updates (see [`security_headers_and_csp.md`](conceal-bridge-ux/ai_spec/security_headers_and_csp.md:41)).\n\nThis spec assumes (1) initially because it aligns with the current architecture (backend-driven swap state polling via [`SwapPage.startPolling()`](conceal-bridge-ux/src/app/pages/swap/swap.page.ts:845)).\n\n## UX / Product Requirements\n\n1. **Network selector must allow EVM↔EVM**\n   - Remove/adjust the “one side must be CCX” enforcement (currently in [`HomePage.normalizeNetworks()`](conceal-bridge-ux/src/app/pages/home/home.page.ts:359)).\n2. **New swap direction**\n   - Introduce a third swap direction: `evm-to-evm`.\n3. **Wallet UX**\n   - Continue using existing wallet connect and network switching behavior:\n     - connect modal: [`WalletButtonComponent`](conceal-bridge-ux/src/app/shared/wallet/wallet-button.component.ts:309)\n     - network switching: [`EvmWalletService.ensureChain()`](conceal-bridge-ux/src/app/core/evm-wallet.service.ts:205)\n4. **Error-handling consistency**\n   - Follow existing conventions (`pageError` vs `statusMessage`) from [`SwapPage`](conceal-bridge-ux/src/app/pages/swap/swap.page.ts:445) and guidance in [`error_handling.md`](conceal-bridge-ux/docs/error_handling.md:30).\n5. **Safety \u0026 clarity**\n   - Must show from/to networks clearly at all times.\n   - Must not allow double-submission / double-execution.\n\n## API Contract (Proposed)\n\n\u003e Exact naming may differ; the goal is to define the minimum needed primitives.\n\n### A) Quote endpoint\n\n- `POST /{network}/api/evm/evm/quote`\n- Request:\n  - `fromChainId`, `toChainId`\n  - `fromToken`, `toToken` (addresses or canonical identifiers)\n  - `amount` (string/decimal or integer in smallest units)\n  - `toAddress`\n- Response:\n  - `success: boolean`\n  - `quoteId`\n  - `expectedAmountOut`\n  - `feesBreakdown`\n  - `expiresAt`\n  - optional: transaction request template (to be signed)\n\n### B) Execute endpoint\n\n- `POST /{network}/api/evm/evm/exec`\n- Request:\n  - `quoteId`\n  - `userTxHash` (if user must send an on-chain tx)\n  - optional: `email` (if you keep parity with current init flows)\n- Response:\n  - `success: boolean`\n  - `paymentId` (or similar stable tracking id)\n\n### C) Status endpoint (polling)\n\n- `POST /{network}/api/evm/evm/tx`\n- Request:\n  - `paymentId`\n- Response:\n  - `result: boolean`\n  - `txdata` with:\n    - `sourceTxHash`\n    - `destinationTxHash`\n    - `fromChainId`, `toChainId`\n    - `fromAmount`, `toAmount`\n\n**Rule:** status endpoint must be safe/idempotent for polling retry (align with polling design in [`SwapPage.startPolling()`](conceal-bridge-ux/src/app/pages/swap/swap.page.ts:845)).\n\n## UI Flow (Proposed)\n\n1. **Home**\n   - Allow selection of EVM on both sides.\n   - When submitting, route to a new swap route:\n     - `/swap/evm-to-evm/\u003cfromNetworkKey\u003e-to-\u003ctoNetworkKey\u003e` (example)\n   - Alternatively, extend route params (recommended):\n     - `/swap/:direction/:from/:to`\n\n2. **Swap Page**\n   - New mode `evm-to-evm` with steps similar to current flows:\n     - Step 0: Validate input (recipient address, amount)\n     - Step 1: Quote + user approval (show fees, expected output)\n     - Step 2: User signs/sends tx (if required)\n     - Step 3: Poll status until completion\n\n## Validation / Security Requirements\n\n- Address validation uses viem `isAddress` (pattern already used in [`SwapPage`](conceal-bridge-ux/src/app/pages/swap/swap.page.ts:9)).\n- Must enforce:\n  - min/max amounts per backend quote response (do not guess in UI).\n  - slippage or “price protection” rules (separate spec if DEX-like).\n- Do not store sensitive swap details in localStorage (align with rules in [`security.md`](conceal-bridge-ux/docs/security.md:1)).\n\n## Observability\n\nLog key events via the planned logging system (see [`observability_and_client_logging.md`](conceal-bridge-ux/ai_spec/observability_and_client_logging.md:1)):\n\n- `swap.evmToEvm.quote.start|success|error`\n- `swap.evmToEvm.exec.start|success|error`\n- `swap.evmToEvm.polling.timeout|recovered|completed`\n\n## Testing Plan\n\n- Unit/component tests:\n  - Ensure Home allows EVM↔EVM selection and routes correctly.\n  - Ensure Swap page validates addresses/amounts and shows correct step transitions.\n- E2E:\n  - Use the approach in [`e2e_testing.md`](conceal-bridge-ux/ai_spec/e2e_testing.md:45):\n    - mock backend quote/exec/status endpoints\n    - inject fake wallet provider\n    - verify UI reaches completion via polling\n\n## Risks / Considerations\n\n- EVM↔EVM “swap” may require bridging + liquidity routing; complexity depends on backend.\n- UI must avoid confusing EVM↔EVM swaps with the CCX bridge product promise.\n- Any new third-party SDK will impact CSP and must be allowlisted per [`security_headers_and_csp.md`](conceal-bridge-ux/ai_spec/security_headers_and_csp.md:41).\n\n## Implementation Steps (Work Breakdown)\n\n1. Define route shape changes (new params) in [`app.routes.ts`](conceal-bridge-ux/src/app/app.routes.ts:3).\n2. Update Home network selection logic in [`HomePage.normalizeNetworks()`](conceal-bridge-ux/src/app/pages/home/home.page.ts:359) and submit logic in [`HomePage.go()`](conceal-bridge-ux/src/app/pages/home/home.page.ts:425).\n3. Add new UI path in [`SwapPage`](conceal-bridge-ux/src/app/pages/swap/swap.page.ts:400) for `evm-to-evm`.\n4. Add backend API methods to [`BridgeApiService`](conceal-bridge-ux/src/app/core/bridge-api.service.ts:13) (or a new dedicated service) for quote/exec/status.\n5. Add tests (unit + E2E per [`e2e_testing.md`](conceal-bridge-ux/ai_spec/e2e_testing.md:1)).","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T12:50:00.102320509Z","updated_at":"2025-12-20T12:54:13.383126822Z"}
{"id":"conceal-bridge-ux-a7s","title":"Implement Bridge Explorer / Swap History","description":"## Context / Current State\n\n- The current UX is designed around a single “in-progress session”:\n  - The swap page tracks `paymentId`, tx hashes, and completion state in-memory signals in [`SwapPage`](conceal-bridge-ux/src/app/pages/swap/swap.page.ts:400).\n- There is no persistent history or account dashboard in the UI.\n- A “bridge explorer” / history view is explicitly listed as a non-goal in the example spec:\n  - see “A full ‘bridge explorer’…” in [`example.md`](conceal-bridge-ux/ai_spec/example.md:17).\n\n## Goal\n\nAdd an optional, privacy-preserving “Swap History / Explorer” feature so users can:\n\n- review recent swaps and their status\n- re-open a swap by payment ID\n- view tx hashes and destinations in a consistent way\n- recover state after closing the tab (within reasonable constraints)\n\n## Non-Goals\n\n- Building a full blockchain explorer.\n- Storing sensitive user data (emails, full wallet addresses) by default.\n- Requiring wallet connection to use history (should be optional).\n\n## UX Requirements\n\n1. Add a new route and page:\n   - `/history` (or `/explorer`) listing recent swaps\n2. Each entry shows:\n   - direction (CCX→EVM / EVM→CCX)\n   - network (eth/bsc/plg)\n   - amount\n   - status (pending / processing / completed / failed)\n   - payment ID (copyable)\n   - tx hashes (copyable / link to explorers)\n3. Search:\n   - allow lookup by payment ID\n4. Privacy:\n   - do not show full wallet addresses by default (shorten/mask)\n   - do not store user email in history\n\n## Data Requirements (Decision Needed)\n\nChoose one approach:\n\n### A) Backend-provided history (recommended for accuracy)\n\n- Backend exposes a read-only endpoint to fetch swap records by payment ID and/or by address (if feasible).\n- UI stores only a list of recent payment IDs locally for convenience.\n\n### B) Client-local history (privacy-first, limited)\n\n- UI stores recent swap records in local storage:\n  - paymentId\n  - direction, network\n  - timestamps\n  - tx hashes (if available)\n- UI revalidates status by calling existing status endpoints via [`BridgeApiService.checkSwapState()`](conceal-bridge-ux/src/app/core/bridge-api.service.ts:92).\n\n## Security / Privacy Requirements\n\n- Never persist secrets.\n- Avoid persisting:\n  - user email\n  - full wallet addresses\n- If local storage is used:\n  - keep a strict retention policy (e.g., last 10 swaps or last 30 days)\n  - provide a “Clear history” action\n\nAlign with guidance in:\n\n- [`security.md`](conceal-bridge-ux/docs/security.md:1)\n\n## Error Handling\n\n- Use the established UI convention:\n  - blocking error for page load failures\n  - status messages for transient failures\n    Align with:\n- [`error_handling.md`](conceal-bridge-ux/docs/error_handling.md:30)\n\n## Testing Plan\n\n- Unit tests:\n  - storage retention rules\n  - masking behavior\n- E2E tests (once E2E framework exists):\n  - navigate to history, view entries, open details\n  - search by payment ID\n\nSee E2E approach:\n\n- [`e2e_testing.md`](conceal-bridge-ux/ai_spec/e2e_testing.md:1)\n\n## Implementation Steps (Work Breakdown)\n\n1. Define data strategy (backend vs local).\n2. Add route in [`app.routes.ts`](conceal-bridge-ux/src/app/app.routes.ts:3).\n3. Implement `HistoryPage` UI and interactions.\n4. Add service for persistence (if client-local).\n5. Add tests (unit + E2E later).","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-20T12:49:24.780127971Z","updated_at":"2025-12-20T12:54:13.298107954Z"}
{"id":"conceal-bridge-ux-oau","title":"Implement HTTP Conventions \u0026 Error Handling","description":"## Context / Current State\n\n- HTTP is provided globally via [`provideHttpClient()`](conceal-bridge-ux/src/app/app.config.ts:2).\n- There are no HTTP interceptors configured today (same file: [`app.config.ts`](conceal-bridge-ux/src/app/app.config.ts:7)).\n- Backend calls are centralized in [`BridgeApiService`](conceal-bridge-ux/src/app/core/bridge-api.service.ts:13), which builds URLs using `APP_CONFIG.apiBaseUrl` (see [`#url()`](conceal-bridge-ux/src/app/core/bridge-api.service.ts:20)).\n- Components handle errors with local `catchError` + UI signals (example in [`SwapPage`](conceal-bridge-ux/src/app/pages/swap/swap.page.ts:489)).\n- Swap flows include backend polling loops using RxJS `timer` and `switchMap` (see [`startPolling()`](conceal-bridge-ux/src/app/pages/swap/swap.page.ts:845)).\n\n## Goal\n\nDefine a consistent, best-practice HTTP/error-handling approach for this Angular 21 SPA so that:\n\n- request timeouts and transient failures are handled predictably\n- user-facing messages are consistent and actionable\n- logging/telemetry can be added without sprinkling `console.error`\n- polling behavior does not overload the backend and can be canceled cleanly\n\n## Non-Goals\n\n- Rewriting all API endpoints or changing backend contract.\n- Adding full observability stack (Sentry/etc.) in this spec (can be a follow-up).\n- Implementing auth (no auth exists today).\n\n## Requirements\n\n1. **Centralized error mapping**:\n   - map `HttpErrorResponse` into a small set of user-facing messages + machine-readable categories\n2. **Timeout policy**:\n   - requests should not hang indefinitely (especially swap init and status calls)\n3. **Retry policy**:\n   - only for idempotent requests (GET and safe polling calls)\n   - do not blindly retry swap-init endpoints\n4. **Consistent UI messaging**:\n   - follow the existing `pageError` / `statusMessage` pattern in [`SwapPage`](conceal-bridge-ux/src/app/pages/swap/swap.page.ts:445)\n5. **Cancelable polling**:\n   - ensure polling stops on navigation and on completion (already does `takeUntilDestroyed()` in [`startPolling()`](conceal-bridge-ux/src/app/pages/swap/swap.page.ts:855))\n\n## Proposed Solution\n\n### A) Introduce an HTTP Interceptor Layer\n\nAdd one interceptor for:\n\n- request correlation (optional request ID)\n- default headers if needed\n- centralized error mapping\n- optional timeout enforcement\n\nIn Angular 21 standalone, register interceptors using `provideHttpClient(withInterceptors([...]))` in [`app.config.ts`](conceal-bridge-ux/src/app/app.config.ts:7).\n\n### B) Add a small “ApiError” mapping utility\n\nCreate a helper that converts an error into:\n\n- `kind`: `'network' | 'timeout' | 'server' | 'client' | 'unauthorized' | 'notFound' | 'unknown'`\n- `message`: user-facing string\n- `status` (optional)\n\nProposed location:\n\n- [`conceal-bridge-ux/src/app/core/api-error.ts`](conceal-bridge-ux/src/app/core/api-error.ts:1)\n\n### C) Apply strict retry rules\n\nRules:\n\n- `GET` requests: retry on network/5xx with exponential backoff (small max attempts)\n- `POST` requests:\n  - **do not retry** swap-init endpoints (they may not be idempotent)\n  - allow retry only for safe “status polling” POST endpoints if backend guarantees idempotency (e.g. [`checkSwapState()`](conceal-bridge-ux/src/app/core/bridge-api.service.ts:92) posts a `paymentId` for status; this is likely safe)\n\n### D) Establish timeouts\n\nDefine per-endpoint timeouts (examples):\n\n- config endpoints: 10s\n- balance endpoints: 10s\n- swap init/exec: 20–30s\n- polling call: 10s\n\nImplementation choices:\n\n- in interceptor (global default) with overrides via custom header\n- or in service methods using RxJS `timeout()` operator\n\nThis spec recommends:\n\n- global default timeout in interceptor, and allow overrides for long calls.\n\n### E) UI messaging conventions\n\nStandardize messages:\n\n- “Could not reach server. Check your connection.”\n- “The server is taking too long to respond.”\n- “Swap initialization failed. Please try again.”\n- etc.\n\nKeep using signals in pages and set messages consistently:\n\n- `pageError` for route-blocking errors (e.g. missing config)\n- `statusMessage` for step-level status and transient notifications\n\n## Acceptance Criteria\n\n1. A centralized error mapping exists and is used consistently.\n2. App has a documented retry/timeout policy by endpoint class.\n3. Polling calls are safe, cancelable, and do not leak subscriptions.\n4. User-facing errors are consistent across pages.\n\n## Testing Plan\n\n- Unit tests for:\n  - api error mapping function (various Http statuses)\n  - retry/backoff logic (marble tests if desired)\n- Manual tests:\n  - offline mode → verify “network” message\n  - backend 500 → verify “server” message\n  - slow backend → verify timeout message\n  - polling continues until success and stops after completion (verify via network tab)\n\n## Risks / Considerations\n\n- Retrying non-idempotent requests can cause double-swaps; the spec explicitly forbids this.\n- Backend-specific error payloads may need parsing; ensure mapping handles unknown shapes gracefully.\n\n## Implementation Steps (Work Breakdown)\n\n1. Add [`api-error.ts`](conceal-bridge-ux/src/app/core/api-error.ts:1) (type + mapper).\n2. Add interceptor file (e.g. [`api-http.interceptor.ts`](conceal-bridge-ux/src/app/core/api-http.interceptor.ts:1)).\n3. Register interceptor(s) in [`app.config.ts`](conceal-bridge-ux/src/app/app.config.ts:7) via `withInterceptors`.\n4. Update [`BridgeApiService`](conceal-bridge-ux/src/app/core/bridge-api.service.ts:13) and pages as needed to adopt consistent mapping/messages.\n5. Add tests for mapping and timeout/retry behavior.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-20T12:50:00.191812961Z","updated_at":"2025-12-20T12:54:12.998826602Z"}
{"id":"conceal-bridge-ux-q7o","title":"Setup E2E Testing Framework","description":"## Context / Current State\n\n- The project does not have an E2E framework configured (noted in [`README.md`](conceal-bridge-ux/README.md:53)).\n- Core user journeys are highly flow-based:\n  - routing (home → swap) via [`routes`](conceal-bridge-ux/src/app/app.routes.ts:3)\n  - wallet connect UX via [`WalletButtonComponent`](conceal-bridge-ux/src/app/shared/wallet/wallet-button.component.ts:8)\n  - swap workflows and polling via [`SwapPage`](conceal-bridge-ux/src/app/pages/swap/swap.page.ts:400)\n- The app depends on:\n  - backend HTTP API ([`BridgeApiService`](conceal-bridge-ux/src/app/core/bridge-api.service.ts:13))\n  - EIP-1193 wallet provider behaviors (injected or WalletConnect) (see [`EvmWalletService`](conceal-bridge-ux/src/app/core/evm-wallet.service.ts:33))\n\n## Goal\n\nAdd an E2E testing setup that can validate the main UX flows reliably in CI, without requiring real wallets or real blockchain interactions.\n\n## Non-Goals\n\n- Testing real blockchain transactions end-to-end.\n- Testing real WalletConnect QR flows in CI (these should be smoke-tested manually).\n\n## Requirements\n\n1. E2E tests must run headless in CI.\n2. Tests must not require real wallet extensions installed.\n3. Backend API calls must be stubbed/mocked consistently.\n4. Validate:\n   - routing works for primary routes and legacy redirects\n   - form validation behaviors\n   - basic swap state polling behavior (mocked)\n5. Keep setup compatible with Angular 21 and standalone bootstrap.\n\n## Proposed Framework\n\nRecommend **Playwright** for E2E:\n\n- stable in CI\n- strong network interception and browser automation\n- good debugging (trace viewer)\n\nAlternative: Cypress (acceptable, but Playwright tends to be more robust for CI + multi-browser).\n\n## Test Strategy\n\n### A) Mock Backend API\n\nUse Playwright network routing to intercept calls generated by [`BridgeApiService`](conceal-bridge-ux/src/app/core/bridge-api.service.ts:20):\n\n- `/[network]/config/chain`\n- `/[network]/api/balance/ccx`\n- `/[network]/api/balance/wccx`\n- `/[network]/api/ccx/wccx/*`\n- `/[network]/api/wccx/ccx/*`\n\nReturn deterministic fixtures:\n\n- chain config with:\n  - `wccx.accountAddress`\n  - `wccx.contractAddress`\n  - `wccx.confirmations`\n  - `wccx.units`\n  - `common.minSwapAmount` / `common.maxSwapAmount`\n  - `ccx.accountAddress`\n- balances with `result:true` and numeric `balance`\n\nPolling behavior:\n\n- first N responses return `{ result:false }`\n- then return `{ result:true, txdata: {...} }`\n  - aligns with [`startPolling()`](conceal-bridge-ux/src/app/pages/swap/swap.page.ts:845) filter on `r.result === true`\n\n### B) Mock Wallet Provider\n\nAvoid real wallet extensions by injecting a fake EIP-1193 provider into the browser context before app load:\n\n- set `window.ethereum` with:\n  - `request({ method })` handling:\n    - `eth_accounts`\n    - `eth_requestAccounts`\n    - `eth_chainId`\n    - `wallet_switchEthereumChain`\n    - `wallet_addEthereumChain`\n    - `wallet_watchAsset`\n    - `eth_sendTransaction` (return fake hash)\n- optionally implement `on` and `removeListener` to support listeners used in [`EvmWalletService.#setProvider()`](conceal-bridge-ux/src/app/core/evm-wallet.service.ts:359)\n\nThis enables `connect` flows in [`EvmWalletService.connect()`](conceal-bridge-ux/src/app/core/evm-wallet.service.ts:134) without user prompts.\n\n### C) Scope: what to test\n\n**Smoke routes**\n\n1. `/` loads home page (contains “Conceal Bridge” from [`HomePage`](conceal-bridge-ux/src/app/pages/home/home.page.ts:28))\n2. Legacy routes redirect:\n   - `/eth` → `swap/ccx-to-evm/eth` per [`app.routes.ts`](conceal-bridge-ux/src/app/app.routes.ts:21)\n   - `/bsc`, `/plg`, `/ccx` similarly\n3. Unknown route shows not-found page ([`NotFoundPage`](conceal-bridge-ux/src/app/pages/not-found/not-found.page.ts:4))\n\n**Home → Swap navigation** 4. Select from/to networks and continue (button “Continue” only enabled when wallet is connected per [`HomePage`](conceal-bridge-ux/src/app/pages/home/home.page.ts:154))\n\n**Swap page validation** 5. For CCX→EVM:\n\n- invalid CCX/EVM address errors show\n- invalid amount errors show\n\n6. For EVM→CCX:\n   - invalid CCX address errors show\n   - insufficient wCCX (mock readContract via provider mock if needed) shows error\n\n**Polling completion** 7. Start swap, verify UI progresses to completion after mocked polling returns success (step logic in [`SwapPage`](conceal-bridge-ux/src/app/pages/swap/swap.page.ts:438))\n\n### D) Test Data Fixtures\n\nStore fixtures under a new folder:\n\n- [`conceal-bridge-ux/e2e/fixtures/`](conceal-bridge-ux/e2e/fixtures:1)\n\nExample files:\n\n- `chain-config.eth.json`, `chain-config.bsc.json`, etc.\n- `swap-state.success.json`\n\n## CI Integration\n\nIntegrate with the pipeline defined in [`ci_cd_pipeline.md`](conceal-bridge-ux/ai_spec/ci_cd_pipeline.md:1):\n\n- Install deps\n- Build or run dev server\n- Run Playwright tests\n\nTypical approach:\n\n- run `ng serve` in CI background and point Playwright to `http://localhost:4200`\n- or run `ng build` + static file server and test against that\n\n## Acceptance Criteria\n\n1. `npm run e2e` exists (or equivalent) and runs headless in CI.\n2. E2E suite covers:\n   - routing + redirects\n   - basic wallet connect UI path (mocked)\n   - swap flow with mocked backend + mocked wallet\n\n## Implementation Steps (Work Breakdown)\n\n1. Add Playwright dependencies and init config:\n   - create [`playwright.config.ts`](conceal-bridge-ux/playwright.config.ts:1)\n2. Add E2E test folder:\n   - [`e2e/`](conceal-bridge-ux/e2e:1)\n3. Implement backend request interception fixtures.\n4. Implement wallet provider injection helper.\n5. Add script(s) in [`package.json`](conceal-bridge-ux/package.json:4):\n   - `e2e`\n6. Add CI job step (see [`ci_cd_pipeline.md`](conceal-bridge-ux/ai_spec/ci_cd_pipeline.md:1)).","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-20T12:50:00.007567304Z","updated_at":"2025-12-20T12:54:13.137054491Z"}
{"id":"conceal-bridge-ux-qn5","title":"Configure Static Hosting Deployment","description":"## Context / Current State\n\n- The project builds an Angular SPA using [`@angular/build:application`](conceal-bridge-ux/angular.json:17).\n- Production build is the default configuration (`defaultConfiguration: \"production\"` in [`angular.json`](conceal-bridge-ux/angular.json:56)).\n- Production build enables `outputHashing: \"all\"` (see [`angular.json`](conceal-bridge-ux/angular.json:48)), which is good for long-term caching.\n- Static assets are served from [`public/`](conceal-bridge-ux/public:1) and included as build assets via [`assets.input = \"public\"`](conceal-bridge-ux/angular.json:24).\n- No deployment target is currently specified (noted in [`build_guide.md`](conceal-bridge-ux/docs/build_guide.md:273)).\n\n## Goal\n\nDefine best-practice deployment requirements for hosting the built SPA on a static host (S3/CloudFront, Netlify, Vercel static, Nginx, etc.) including:\n\n- build output expectations\n- SPA routing rewrites\n- caching policy (hashed assets vs HTML)\n- environment/runtime configuration strategy compatibility\n- security header integration\n\n## Non-Goals\n\n- Selecting a single provider.\n- Providing full IaC for every platform (platform-specific snippets are optional appendices).\n\n## Requirements\n\n1. Host must serve the SPA correctly for client-side routing:\n   - routes in [`app.routes.ts`](conceal-bridge-ux/src/app/app.routes.ts:3) must work on full page refresh\n2. Cache strategy must:\n   - aggressively cache hashed static assets\n   - avoid caching `index.html` too aggressively\n3. Deployment must be compatible with:\n   - build-time env files (see [`environment_configuration.md`](conceal-bridge-ux/ai_spec/environment_configuration.md:1))\n   - optional runtime config file (see [`runtime_config.md`](conceal-bridge-ux/ai_spec/runtime_config.md:1))\n4. Security headers must be applied at the edge (see [`security_headers_and_csp.md`](conceal-bridge-ux/ai_spec/security_headers_and_csp.md:1))\n\n## Build Output\n\nAfter `npm run build` (script in [`package.json`](conceal-bridge-ux/package.json:7)):\n\n- output folder: `conceal-bridge-ux/dist/conceal-bridge-ux/` (default Angular dist naming)\n- contains:\n  - `index.html`\n  - hashed JS/CSS bundles (because of `outputHashing: \"all\"`)\n  - copied assets from [`public/`](conceal-bridge-ux/public:1) (e.g. `/images/...`)\n\n## SPA Routing Requirements (Rewrites)\n\nBecause this is an SPA using Angular Router (see [`provideRouter(routes)`](conceal-bridge-ux/src/app/app.config.ts:11)), hosting must rewrite unknown paths to `index.html`.\n\n**Generic rule:**\n\n- If request path is not a real file, serve `/index.html`.\n\nExamples:\n\n- `/swap/ccx-to-evm/eth` should serve `index.html` and let Angular route it.\n- Legacy redirects like `/eth` are handled by Angular router config in [`app.routes.ts`](conceal-bridge-ux/src/app/app.routes.ts:21).\n\n## Caching Policy (Best Practice)\n\n### 1) Hashed assets (JS/CSS/images built with hashes)\n\nFor files like:\n\n- `/*.js`\n- `/*.css`\n- hashed chunks under the build output\n\nSet:\n\n- `Cache-Control: public, max-age=31536000, immutable`\n\nRationale:\n\n- hashes change when content changes.\n\n### 2) `index.html`\n\nSet:\n\n- `Cache-Control: no-cache`\n\nRationale:\n\n- ensures clients fetch latest HTML that references new bundle hashes.\n\n### 3) Runtime config file (if adopted)\n\nIf you implement [`runtime_config.md`](conceal-bridge-ux/ai_spec/runtime_config.md:1) and serve:\n\n- [`/config.json`](conceal-bridge-ux/public/config.json:1)\n\nSet:\n\n- `Cache-Control: no-cache`\n\nSo ops can update config without redeploying assets.\n\n## Base Href / Subpath Hosting\n\nIf hosting under a subpath (e.g. `https://example.com/bridge/`), build with:\n\n- `ng build --base-href /bridge/`\n\nAlso configure the host rewrite rules to rewrite under that subpath.\n\n## Environment Strategy Compatibility\n\n### Build-time environments\n\nWhen environment files are introduced (per [`environment_configuration.md`](conceal-bridge-ux/ai_spec/environment_configuration.md:1)), builds produce different bundles per env.\n\nRecommended:\n\n- production bundle deployed to production host\n- development/testing bundle deployed to testing host\n\n### Runtime config\n\nIf you deploy the same bundle to multiple envs, adopt runtime config (per [`runtime_config.md`](conceal-bridge-ux/ai_spec/runtime_config.md:1)) and vary only `config.json`.\n\n## Security Headers Integration\n\nApply at the CDN/host level:\n\n- CSP + other headers in [`security_headers_and_csp.md`](conceal-bridge-ux/ai_spec/security_headers_and_csp.md:1)\n\nAt minimum:\n\n- `X-Content-Type-Options: nosniff`\n- `Referrer-Policy: strict-origin-when-cross-origin`\n- `Content-Security-Policy` (start report-only)\n\n## Observability / Error Pages (Optional)\n\n- Provide a static `404` that still serves `index.html` for SPA routes (host-specific).\n- Consider a basic “maintenance mode” page for backend outages.\n\n## Acceptance Criteria\n\n1. Refreshing a deep route (e.g. `/swap/ccx-to-evm/eth`) loads the app successfully.\n2. Hashed assets are long-cacheable, `index.html` is not.\n3. If runtime config is used, `config.json` updates take effect without rebuild and without cache delays.\n4. Security headers are applied without breaking required network connections (backend, WalletConnect, chain metadata).\n\n## Implementation Steps (Work Breakdown)\n\n1. Choose hosting platform.\n2. Implement rewrite rule to `index.html`.\n3. Implement cache headers:\n   - immutable for hashed assets\n   - no-cache for `index.html`\n   - no-cache for `config.json` (if used)\n4. Apply headers from [`security_headers_and_csp.md`](conceal-bridge-ux/ai_spec/security_headers_and_csp.md:1).\n5. Validate with smoke tests and E2E where possible (see [`e2e_testing.md`](conceal-bridge-ux/ai_spec/e2e_testing.md:1)).","status":"in_progress","priority":0,"issue_type":"task","created_at":"2025-12-20T12:49:59.932644775Z","updated_at":"2025-12-24T02:04:50.195876043Z"}
{"id":"conceal-bridge-ux-ruw","title":"Implement CI/CD Pipeline","description":"## Context / Current State\n\n- No CI configuration exists in this project folder (the build guide notes this gap in [`build_guide.md`](conceal-bridge-ux/docs/build_guide.md:277)).\n- The project has these key scripts in [`package.json`](conceal-bridge-ux/package.json:4):\n  - `start`: `ng serve`\n  - `build`: `ng build` (defaults to production config per [`angular.json`](conceal-bridge-ux/angular.json:56))\n  - `test`: `ng test`\n- Package manager is pinned via `\"packageManager\": \"npm@11.7.0\"` in [`package.json`](conceal-bridge-ux/package.json:24).\n- Angular build is configured via the application builder in [`angular.json`](conceal-bridge-ux/angular.json:17).\n\n## Goal\n\nDefine a CI/CD pipeline that:\n\n- reliably installs deps, runs tests, runs lint (after lint spec is implemented), and builds\n- produces a versioned build artifact suitable for static hosting\n- optionally deploys to hosting (platform-specific, but the pipeline should define interfaces)\n- supports multiple environments (production vs testing) aligned with the environment strategy spec in [`environment_configuration.md`](conceal-bridge-ux/ai_spec/environment_configuration.md:1)\n\n## Non-Goals\n\n- Choosing a specific hosting provider (unless requested).\n- Building a monorepo pipeline for other folders (this spec is for `conceal-bridge-ux` only).\n\n## Requirements\n\n1. CI must be deterministic:\n   - uses pinned Node/npm versions\n   - uses `npm ci` (not `npm install`)\n2. CI must run:\n   - tests: `npm run test` (from [`package.json`](conceal-bridge-ux/package.json:9))\n   - lint: `npm run lint` (to be added in [`linting_and_formatting.md`](conceal-bridge-ux/ai_spec/linting_and_formatting.md:1))\n   - build: `npm run build`\n3. Build output should be captured as an artifact:\n   - `dist/conceal-bridge-ux` (default Angular dist folder, based on project name and [`angular.json`](conceal-bridge-ux/angular.json:9))\n4. Deployment should be environment-aware:\n   - production deploy on `main` (or a tagged release)\n   - testing/staging deploy on `develop` or manually triggered\n\n## Proposed CI Tooling\n\nThis spec is CI-tool agnostic. Recommended implementations:\n\n- GitHub Actions\n- GitLab CI\n- Jenkins\n\nThe pipeline stages remain the same.\n\n## Pipeline Stages\n\n### Stage 1 — Checkout + Toolchain Setup\n\n**Inputs:**\n\n- Node version (pin using `.nvmrc` or CI config)\n- npm version pinned to `\"npm@11.7.0\"` in [`package.json`](conceal-bridge-ux/package.json:24)\n\n**Actions:**\n\n1. Checkout repo\n2. Install Node (recommended: LTS compatible with npm 11.x; pin explicitly)\n3. Ensure npm version:\n   - either rely on Corepack (recommended) or `npm i -g npm@11.7.0`\n\n### Stage 2 — Install Dependencies\n\nRun from the project directory:\n\n- `cd conceal-bridge-ux \u0026\u0026 npm ci`\n\nRationale:\n\n- `npm ci` ensures lockfile fidelity and reproducible builds (lockfile exists at [`package-lock.json`](conceal-bridge-ux/package-lock.json:1)).\n\n### Stage 3 — Static Checks (Lint + Type Checks)\n\nAfter implementing lint tooling per [`linting_and_formatting.md`](conceal-bridge-ux/ai_spec/linting_and_formatting.md:1):\n\n- `npm run lint`\n\nOptional additional checks:\n\n- `tsc -p tsconfig.app.json --noEmit` (if you want a separate explicit typecheck step)\n  - [`tsconfig.app.json`](conceal-bridge-ux/tsconfig.app.json:1)\n\n### Stage 4 — Unit Tests\n\nRun:\n\n- `npm run test`\n\nNotes:\n\n- This uses Angular unit test builder in [`angular.json`](conceal-bridge-ux/angular.json:70).\n- Vitest is present as a dev dependency in [`package.json`](conceal-bridge-ux/package.json:48), and types are configured in [`tsconfig.spec.json`](conceal-bridge-ux/tsconfig.spec.json:7).\n\nCI expectations:\n\n- run headless (ensure test builder is configured accordingly if needed)\n- publish test results if the CI tool supports it (JUnit or similar)\n\n### Stage 5 — Build\n\nRun:\n\n- `npm run build`\n\nImportant detail:\n\n- Default build configuration is production (`defaultConfiguration` is `\"production\"` in [`angular.json`](conceal-bridge-ux/angular.json:56)).\n\nIf supporting a testing build output (optional):\n\n- `ng build --configuration development` or a dedicated `testing` config (see [`environment_configuration.md`](conceal-bridge-ux/ai_spec/environment_configuration.md:1)).\n\n### Stage 6 — Artifact Packaging\n\nArchive:\n\n- `conceal-bridge-ux/dist/` or specifically `conceal-bridge-ux/dist/conceal-bridge-ux/`\n\nRecommended artifact naming:\n\n- include commit SHA and environment:\n  - `conceal-bridge-ux-${GIT_SHA}.zip`\n\n### Stage 7 — Deployment (Optional, Target-Specific)\n\nThis stage depends on hosting provider. The spec defines an interface:\n\n**Inputs:**\n\n- artifact path (dist)\n- environment name (`production`, `testing`, `staging`)\n- target base URL / domain\n- SPA routing support (rewrite rules)\n- caching rules (hashed assets vs index)\n\nThe details are specified in the deployment spec:\n\n- [`deployment_static_hosting.md`](conceal-bridge-ux/ai_spec/deployment_static_hosting.md:1)\n\n## Environment Strategy\n\nCI must align with the environment config approach:\n\n- build-time env via file replacements (recommended in [`environment_configuration.md`](conceal-bridge-ux/ai_spec/environment_configuration.md:1))\n- optionally runtime config (if adopted) per [`runtime_config.md`](conceal-bridge-ux/ai_spec/runtime_config.md:1)\n\n## Branch / Trigger Strategy (Recommended)\n\n- `main`:\n  - run CI on PR + push\n  - deploy to production on merge to `main` (or on tag `v*`)\n- `develop` (optional):\n  - deploy to testing/staging\n- manual workflow dispatch:\n  - allow choosing environment + commit/tag\n\n## Security Considerations\n\n- Do not store secrets in environment files (they are bundled).\n- Use CI secrets store for deploy credentials.\n- Add security headers / CSP in hosting layer per [`security_headers_and_csp.md`](conceal-bridge-ux/ai_spec/security_headers_and_csp.md:1).\n\n## Acceptance Criteria\n\n1. CI can run on a clean machine and produce a build artifact.\n2. CI fails on lint/test/build failures.\n3. CI produces deterministic builds using [`package-lock.json`](conceal-bridge-ux/package-lock.json:1) and `npm ci`.\n4. Deployment (if enabled) updates hosting with SPA-compatible routing and correct cache headers.\n\n## Implementation Steps (Work Breakdown)\n\n1. Choose CI system (GitHub Actions recommended).\n2. Add CI config file(s) under the repo (location depends on CI system).\n3. Implement lint tooling first (see [`linting_and_formatting.md`](conceal-bridge-ux/ai_spec/linting_and_formatting.md:1)).\n4. Add environment configuration (see [`environment_configuration.md`](conceal-bridge-ux/ai_spec/environment_configuration.md:1)).\n5. Add artifact upload step.\n6. Add deployment steps + hosting configuration.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-20T12:49:59.851599694Z","updated_at":"2025-12-20T12:54:12.831482358Z"}
