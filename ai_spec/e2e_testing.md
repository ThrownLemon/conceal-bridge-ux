# Spec: End-to-End Testing (E2E) — conceal Bridge UX

## Context / Current State

- The project does not have an E2E framework configured (noted in [`README.md`](conceal-bridge-ux/README.md:53)).
- Core user journeys are highly flow-based:
  - routing (home → swap) via [`routes`](conceal-bridge-ux/src/app/app.routes.ts:3)
  - wallet connect UX via [`WalletButtonComponent`](conceal-bridge-ux/src/app/shared/wallet/wallet-button.component.ts:8)
  - swap workflows and polling via [`SwapPage`](conceal-bridge-ux/src/app/pages/swap/swap.page.ts:400)
- The app depends on:
  - backend HTTP API ([`BridgeApiService`](conceal-bridge-ux/src/app/core/bridge-api.service.ts:13))
  - EIP-1193 wallet provider behaviors (injected or WalletConnect) (see [`EvmWalletService`](conceal-bridge-ux/src/app/core/evm-wallet.service.ts:33))

## Goal

Add an E2E testing setup that can validate the main UX flows reliably in CI, without requiring real wallets or real blockchain interactions.

## Non-Goals

- Testing real blockchain transactions end-to-end.
- Testing real WalletConnect QR flows in CI (these should be smoke-tested manually).

## Requirements

1. E2E tests must run headless in CI.
2. Tests must not require real wallet extensions installed.
3. Backend API calls must be stubbed/mocked consistently.
4. Validate:
   - routing works for primary routes and legacy redirects
   - form validation behaviors
   - basic swap state polling behavior (mocked)
5. Keep setup compatible with Angular 21 and standalone bootstrap.

## Proposed Framework

Recommend **Playwright** for E2E:

- stable in CI
- strong network interception and browser automation
- good debugging (trace viewer)

Alternative: Cypress (acceptable, but Playwright tends to be more robust for CI + multi-browser).

## Test Strategy

### A) Mock Backend API

Use Playwright network routing to intercept calls generated by [`BridgeApiService`](conceal-bridge-ux/src/app/core/bridge-api.service.ts:20):

- `/[network]/config/chain`
- `/[network]/api/balance/ccx`
- `/[network]/api/balance/wccx`
- `/[network]/api/ccx/wccx/*`
- `/[network]/api/wccx/ccx/*`

Return deterministic fixtures:

- chain config with:
  - `wccx.accountAddress`
  - `wccx.contractAddress`
  - `wccx.confirmations`
  - `wccx.units`
  - `common.minSwapAmount` / `common.maxSwapAmount`
  - `ccx.accountAddress`
- balances with `result:true` and numeric `balance`

Polling behavior:

- first N responses return `{ result:false }`
- then return `{ result:true, txdata: {...} }`
  - aligns with [`startPolling()`](conceal-bridge-ux/src/app/pages/swap/swap.page.ts:845) filter on `r.result === true`

### B) Mock Wallet Provider

Avoid real wallet extensions by injecting a fake EIP-1193 provider into the browser context before app load:

- set `window.ethereum` with:
  - `request({ method })` handling:
    - `eth_accounts`
    - `eth_requestAccounts`
    - `eth_chainId`
    - `wallet_switchEthereumChain`
    - `wallet_addEthereumChain`
    - `wallet_watchAsset`
    - `eth_sendTransaction` (return fake hash)
- optionally implement `on` and `removeListener` to support listeners used in [`EvmWalletService.#setProvider()`](conceal-bridge-ux/src/app/core/evm-wallet.service.ts:359)

This enables `connect` flows in [`EvmWalletService.connect()`](conceal-bridge-ux/src/app/core/evm-wallet.service.ts:134) without user prompts.

### C) Scope: what to test

**Smoke routes**

1. `/` loads home page (contains “Conceal Bridge” from [`HomePage`](conceal-bridge-ux/src/app/pages/home/home.page.ts:28))
2. Legacy routes redirect:
   - `/eth` → `swap/ccx-to-evm/eth` per [`app.routes.ts`](conceal-bridge-ux/src/app/app.routes.ts:21)
   - `/bsc`, `/plg`, `/ccx` similarly
3. Unknown route shows not-found page ([`NotFoundPage`](conceal-bridge-ux/src/app/pages/not-found/not-found.page.ts:4))

**Home → Swap navigation** 4. Select from/to networks and continue (button “Continue” only enabled when wallet is connected per [`HomePage`](conceal-bridge-ux/src/app/pages/home/home.page.ts:154))

**Swap page validation** 5. For CCX→EVM:

- invalid CCX/EVM address errors show
- invalid amount errors show

6. For EVM→CCX:
   - invalid CCX address errors show
   - insufficient wCCX (mock readContract via provider mock if needed) shows error

**Polling completion** 7. Start swap, verify UI progresses to completion after mocked polling returns success (step logic in [`SwapPage`](conceal-bridge-ux/src/app/pages/swap/swap.page.ts:438))

### D) Test Data Fixtures

Store fixtures under a new folder:

- [`conceal-bridge-ux/e2e/fixtures/`](conceal-bridge-ux/e2e/fixtures:1)

Example files:

- `chain-config.eth.json`, `chain-config.bsc.json`, etc.
- `swap-state.success.json`

## CI Integration

Integrate with the pipeline defined in [`ci_cd_pipeline.md`](conceal-bridge-ux/ai_spec/ci_cd_pipeline.md:1):

- Install deps
- Build or run dev server
- Run Playwright tests

Typical approach:

- run `ng serve` in CI background and point Playwright to `http://localhost:4200`
- or run `ng build` + static file server and test against that

## Acceptance Criteria

1. `npm run e2e` exists (or equivalent) and runs headless in CI.
2. E2E suite covers:
   - routing + redirects
   - basic wallet connect UI path (mocked)
   - swap flow with mocked backend + mocked wallet

## Implementation Steps (Work Breakdown)

1. Add Playwright dependencies and init config:
   - create [`playwright.config.ts`](conceal-bridge-ux/playwright.config.ts:1)
2. Add E2E test folder:
   - [`e2e/`](conceal-bridge-ux/e2e:1)
3. Implement backend request interception fixtures.
4. Implement wallet provider injection helper.
5. Add script(s) in [`package.json`](conceal-bridge-ux/package.json:4):
   - `e2e`
6. Add CI job step (see [`ci_cd_pipeline.md`](conceal-bridge-ux/ai_spec/ci_cd_pipeline.md:1)).
